---
- name: Configure application server
  hosts: all
  become: yes
  
  tasks:
    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /opt/app
        - /tmp/app

    # Commande simplifi√©e pour Artifact Registry
    - name: Download application from Artifact Registry
      shell: |
        gcloud artifacts files download app.tar.gz \
          --project={{ project_id | default('cesi-ops') }} \
          --location=europe-west9 \
          --repository=app-repo \
          --destination=/tmp/app/app.tar.gz

    - name: Extract application
      unarchive:
        src: /tmp/app/app.tar.gz
        dest: /opt/app
        remote_src: yes

    - name: Set permissions
      file:
        path: /opt/app
        state: directory
        recurse: yes
        mode: '0755'

    - name: Create systemd service
      template:
        src: app.service.j2
        dest: /etc/systemd/system/app.service
        mode: '0644'
      notify: restart app

  handlers:
    - name: restart app
      systemd:
        name: app
        state: restarted
        daemon_reload: yes

  roles:
    - ops_agent